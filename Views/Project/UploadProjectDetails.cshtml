@using Microsoft.AspNetCore.Mvc.Rendering
@{
    ViewData["Title"] = "Upload Project Details";
    var auditList = ViewBag.AuditList as List<SelectListItem>;
}

<h2>Upload Project Details Excel</h2>

<form id="uploadForm" asp-controller="Project" asp-action="UploadProjectDetails" method="post" enctype="multipart/form-data">
    <div class="form-group">
        <label for="AuditID">Select Audit ID:</label>
        @Html.DropDownList("AuditID", auditList, "-- Select Audit ID --", new { @class = "form-control", required = "required", id = "AuditID" })
    </div>

    <div class="form-group mt-2">
        <label for="file">Select Excel file:</label>
        <input type="file" name="file" id="file" class="form-control" accept=".xlsx, .xls" required />
    </div>

    <div class="mt-3">
        <!-- No Upload button anymore -->
        
        <button type="button" class="btn btn-success" onclick="checkAuditAndUpload()">Upload and View</button>
    </div>
</form>

<div id="message" class="mt-3"></div>

@section Scripts {
    <script>


        function uploadAndRedirect() {
            var auditId = document.getElementById("AuditID").value;
            var fileInput = document.getElementById("file");

            if (!auditId) {
                alert("Please select an Audit ID.");
                return;
            }
            if (!fileInput.files.length) {
                alert("Please select an Excel file.");
                return;
            }

            var formData = new FormData();
            formData.append("AuditID", auditId);
            formData.append("file", fileInput.files[0]);

            fetch('@Url.Action("UploadProjectDetails", "Project")', {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Redirect to view page after successful upload
                    window.location.href = '/project/view/' + encodeURIComponent(auditId);
                } else {
                    document.getElementById("message").innerHTML = '<div class="alert alert-danger">' + data.error + '</div>';
                }
            })
            .catch(error => {
                document.getElementById("message").innerHTML = '<div class="alert alert-danger">Upload failed. Please try again.</div>';
                console.error(error);
            });
        }

           async function checkAuditAndUpload() {
            const auditSelect = document.getElementById("AuditID");
            const selectedAuditId = auditSelect.value;
            const fileInput = document.getElementById("file");

            if (!selectedAuditId) {
                alert("Please select an Audit ID.");
                return;
            }

            try {
                const response = await fetch(`/Project/CheckProjectExists?projectId=${encodeURIComponent(selectedAuditId)}`);
                const data = await response.json();

                if (data.exists) {
                    // Audit ID exists, redirect to view
                    window.location.href = '/project/view/' + encodeURIComponent(selectedAuditId);
                } else {
                    // Audit ID doesn't exist, require file
                    if (!fileInput || !fileInput.files.length) {
                        alert("Audit ID does not exist. Please select a file to upload.");
                        fileInput.focus();
                        return;
                    }

                    const formData = new FormData();
                    formData.append("file", fileInput.files[0]);
                    formData.append("AuditID", selectedAuditId);

                    const uploadResponse = await fetch('@Url.Action("UploadProjectDetails", "Project")', {
                        method: "POST",
                        body: formData
                    });

                    if (!uploadResponse.ok) {
                        const errorText = await uploadResponse.text();
                        alert("File upload failed: " + errorText);
                        return;
                    }

                    const result = await uploadResponse.json();
                    if (result.success) {
                        window.location.href = '/project/view/' + encodeURIComponent(result.auditId);
                    } else {
                        alert("Upload failed: " + result.error);
                    }
                }
            } catch (error) {
                console.error("Error:", error);
                alert("An error occurred. Please try again.");
            }
        }


    </script>
}
